<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kurasi MPI 2</title>
<link rel="stylesheet" href="styles.css">
</head>

<body>

<header>
  <div class="logo-group">
    <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/9/9c/Logo_of_Ministry_of_Education_and_Culture_of_Republic_of_Indonesia.svg/1200px-Logo_of_Ministry_of_Education_and_Culture_of_Republic_of_Indonesia.svg.png" id="logoHeader">
    <img src="https://trigger.id/wp-content/uploads/2025/05/pendidikan-1024x452.png">
    <img src="https://kemendikdasmen.go.id/kem_base/static/src/img/ramah.png">
    <img src="https://cdn-sdotid.adg.id/images/70b5e75c-f103-4e51-9b76-432a91d07494_980x382.png">
  </div>

  <h1>Kurasi Media Pembelajaran Interaktif Jilid 2</h1>
  <h1>Direktorat Sekolah Dasar</h1>
  <h2 class="sub-header-line">Direktorat Jenderal PAUD, Dikdas, dan Dikmen</h2>
  <h2 class="sub-header-line">Kementerian Pendidikan Dasar dan Menengah</h2>
  <div class="muted">Pilih kurator lalu muat konten untuk dikurasi.</div>

  <div class="controls">
    <select id="kuratorSel">
      <option value="">-- Pilih Kurator --</option>
    </select>
    <button class="btn btn-primary" id="btnLoad">Muat Konten</button>
    <button class="btn btn-secondary" id="btnHasil">Lihat Hasil Kurasi</button>
  </div>
</header>

<div id="listArea" class="card muted">
  Belum ada data. Pilih kurator lalu klik "Muat Konten".
</div>

<div id="kurasiPanel" class="card hidden"></div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbx__Yig33QCnywBPzOU-oD899gdjJL1OWoca7ajKIOsRpvbjx1NZZoDsBd3ZjC42pmi/exec";

/* UTIL */
function esc(s){
  return String(s||'').replace(/[&<>"']/g,m=>(
    {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]
  ));
}

/* LOAD KURATOR */
window.onload = () => {
  fetch(API_URL+'?action=kurators')
    .then(r=>r.json())
    .then(d=>{
      d.forEach(n=>{
        kuratorSel.innerHTML += `<option>${n}</option>`;
      });
    });
};

/* LOAD KONTEN */
btnLoad.onclick = () => {
  const k = kuratorSel.value;
  if(!k) return alert('Pilih kurator');

  listArea.innerHTML = 'Memuat konten...';

  fetch(API_URL+'?action=available&kurator='+encodeURIComponent(k))
    .then(r=>r.json())
    .then(p=>{
      let h = `
      <table>
        <thead>
          <tr>
            <th>Download</th>
            <th>#</th>
            <th>Judul</th>
            <th>Aksi</th>
          </tr>
        </thead><tbody>`;

      p.items.forEach((it,i)=>{
        let dl='-';
        if(it.download){
          if(it.download.toLowerCase().startsWith('http')){
            dl = `<a href="${esc(it.download)}" target="_blank">Download</a>`;
          } else {
            dl = esc(it.download);
          }
        }

        h+=`
        <tr>
          <td>${dl}</td>
          <td>${i+1}</td>
          <td>${esc(it.judul)}</td>
          <td>
            <button class="btn btn-small btn-success"
              onclick="openKurasi(${it.row},'${encodeURIComponent(k)}')">
              Kurasi
            </button>
          </td>
        </tr>`;
      });

      listArea.innerHTML = h+'</tbody></table>';
    });
};

/* OPEN KURASI */
function openKurasi(row,kurEnc){
  const kur = decodeURIComponent(kurEnc);
  kurasiPanel.classList.remove('hidden');
  kurasiPanel.innerHTML = 'Memuat form...';

  fetch(API_URL+`?action=payload&row=${row}&kurator=${encodeURIComponent(kur)}`)
    .then(r=>r.json())
    .then(p=>{
      let h = `<h3>${esc(p.sumberJudul)}</h3>`;
      p.questions.forEach((q,i)=>{
        h+=`
          <p><b>${i+1}. ${esc(q)}</b></p>
          <select id="q${i}">
            <option value=""></option>
            <option>Ya</option>
            <option>Tidak</option>
          </select>
          <textarea id="n${i}" rows="2"></textarea>
        `;
        h += `
          <hr>
          <p><b>Komentar Umum / Kesimpulan Akhir</b></p>
          <textarea id="komentar" rows="4"
            placeholder="Tuliskan kesimpulan atau komentar umum atas konten ini..."></textarea>
        `;

      });

      h+=`<button class="btn btn-success"
        onclick="submitKurasi(${row},'${esc(kur)}',${p.questions.length})">
        Kirim
      </button>`;

      kurasiPanel.innerHTML = h;
    });
}

/* SUBMIT */
function submitKurasi(row,kur,qc){
  const a=[],n=[];
  for(let i=0;i<qc;i++){
    a.push(document.getElementById('q'+i).value);
    n.push(document.getElementById('n'+i).value);
  }

  fetch(API_URL,{
    method:'POST',
    headers:{'Content-Type':'text/plain;charset=utf-8'},
    body:JSON.stringify({
      action:'submitKurasi',
      payload:{
        row,
        kurator: kur,
        answers: a,
        notes: n,
        komentar: document.getElementById('komentar')?.value || ''
      }

    })
  }).then(()=>{
    alert('Hasil kurasi tersimpan');
    kurasiPanel.classList.add('hidden');
    btnLoad.click();
  });
}

/* NAV */
btnHasil.onclick = () => location.href='hasilkurasi.html';
</script>
</body>
</html>
