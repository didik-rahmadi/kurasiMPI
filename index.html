<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Kurasi MPI 2</title>
<link rel="stylesheet" href="styles.css">
</head>

<body>

<header>
  <div class="logo-group">
    <img src="https://upload.wikimedia.org/wikipedia/commons/9/9c/Logo_of_Ministry_of_Education_and_Culture_of_Republic_of_Indonesia.svg">
    <img src="https://kemendikdasmen.go.id/kem_base/static/src/img/ramah.png">
  </div>

  <h2>Kurasi Media Pembelajaran Interaktif</h2>
  <div class="controls">
    <select id="kuratorSel">
      <option value="">-- Pilih Kurator --</option>
    </select>
    <button class="btn-primary" onclick="loadKonten()">Muat Konten</button>
    <button class="btn-secondary" onclick="location.href='hasilkurasi.html'">
      Lihat Hasil Kurasi
    </button>
  </div>
</header>

<div id="listArea" class="card muted">Silakan pilih kurator.</div>
<div id="kurasiPanel" class="card hidden"></div>

<script>
const API = "https://script.google.com/macros/s/AKfycbx__Yig33QCnywBPzOU-oD899gdjJL1OWoca7ajKIOsRpvbjx1NZZoDsBd3ZjC42pmi/exec";

const esc = s => String(s||'').replace(/[&<>"']/g,m=>(
  {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]
));

async function loadKurator(){
  const r = await fetch(API+'?action=kurators');
  const d = await r.json();
  const s = document.getElementById('kuratorSel');
  d.forEach(v=>s.innerHTML+=`<option>${v}</option>`);
}

async function loadKonten(){
  const k = kuratorSel.value;
  if(!k) return alert('Pilih kurator');
  listArea.innerHTML='Memuat...';
  const r = await fetch(API+'?action=available&kurator='+encodeURIComponent(k));
  const p = await r.json();

  let h = '<table><tr><th>#</th><th>Judul</th><th>Aksi</th></tr>';
  p.items.forEach((it,i)=>{
    h+=`<tr>
      <td>${i+1}</td>
      <td>${esc(it.judul)}</td>
      <td><button class="btn-success"
        onclick="openKurasi(${it.row},'${encodeURIComponent(k)}')">Kurasi</button></td>
    </tr>`;
  });
  listArea.innerHTML=h+'</table>';
}

async function openKurasi(row,kur){
  kurasiPanel.classList.remove('hidden');
  kurasiPanel.innerHTML='Memuat form...';
  const r = await fetch(API+`?action=payload&row=${row}&kurator=${kur}`);
  const p = await r.json();

  let h = `<h3>${esc(p.sumberJudul)}</h3>`;
  p.questions.forEach((q,i)=>{
    h+=`
      <label>${i+1}. ${esc(q)}</label>
      <select id="q${i}"><option></option><option>Ya</option><option>Tidak</option></select>
      <textarea id="n${i}" rows="2"></textarea>
    `;
  });
  h+=`<button class="btn-success" onclick="submit(${row},'${esc(p.kurator)}',${p.questions.length})">
        Kirim</button>`;
  kurasiPanel.innerHTML=h;
}

async function submit(row,kur,qc){
  const a=[],n=[];
  for(let i=0;i<qc;i++){
    a.push(document.getElementById('q'+i).value);
    n.push(document.getElementById('n'+i).value);
  }
  await fetch(API,{
    method:'POST',
    headers:{'Content-Type':'text/plain;charset=utf-8'},
    body:JSON.stringify({action:'submitKurasi',payload:{row,kurator:kur,answers:a,notes:n}})
  });
  alert('Berhasil disimpan');
  kurasiPanel.classList.add('hidden');
  loadKonten();
}

loadKurator();
</script>
</body>
</html>
