<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kurasi MPI 2</title>
<link rel="stylesheet" href="styles.css">
</head>

<body>
<div class="container">
  <header>
    <div class="logo-group">
      <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/9/9c/Logo_of_Ministry_of_Education_and_Culture_of_Republic_of_Indonesia.svg/1200px-Logo_of_Ministry_of_Education_and_Culture_of_Republic_of_Indonesia.svg.png" alt="Logo Kemdikbud">
      <img src="https://trigger.id/wp-content/uploads/2025/05/pendidikan-1024x452.png" alt="Logo Pendidikan">
      <img src="https://kemendikdasmen.go.id/kem_base/static/src/img/ramah.png" alt="Logo Ramah Anak">
      <img src="https://cdn-sdotid.adg.id/images/70b5e75c-f103-4e51-9b76-432a91d07494_980x382.png" alt="Logo Lainnya">
    </div>

    <h1>Kurasi Media Pembelajaran Interaktif Jilid 2</h1>
    <h2 class="sub-header-line">Direktorat Sekolah Dasar</h2>
    <h2 class="sub-header-line">Direktorat Jenderal Pendidikan Anak Usia Dini, Pendidikan Dasar, dan Pendidikan Menengah</h2>
    <h2 class="sub-header-line">Kementerian Pendidikan Dasar dan Menengah</h2>
    <div class="muted">Pilih kurator lalu muat konten untuk dikurasi.</div>

    <div class="controls">
      <select id="kuratorSel">
        <option value="">-- Pilih Kurator --</option>
      </select>
      <button class="btn btn-primary" id="btnLoad">Muat Konten</button>
      <button class="btn btn-secondary" id="btnHasil">Lihat Hasil Kurasi</button>
    </div>
  </header>

  <div id="listArea" class="card">
    <div class="muted" style="text-align:center">Belum ada data. Pilih kurator lalu klik "Muat Konten".</div>
  </div>

  <div id="kurasiPanel" class="card hidden"></div>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbxUlZ3SfTJY-WIDgMrjQAzVfl8aUPNBak3zvOfcLGLuOSNauo4Mjq85qWH6j3Ab6d916A/exec";

/* UTIL */
function esc(s){
  return String(s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}

/* LOAD KURATOR */
window.onload = () => {
  fetch(API_URL+'?action=kurators')
    .then(r=>r.json())
    .then(d=>{
      d.forEach(n=>{
        kuratorSel.innerHTML += `<option>${n}</option>`;
      });
    });
};

/* LOAD KONTEN */
btnLoad.onclick = () => {
  const k = kuratorSel.value;
  if(!k) return alert('Pilih kurator');

  listArea.innerHTML = '<div class="loader"></div><div style="text-align:center">Memuat data...</div>';

  fetch(API_URL+'?action=available&kurator='+encodeURIComponent(k))
    .then(r=>r.json())
    .then(p=>{
      let h = `
      <div class="table-responsive">
        <table>
          <thead>
            <tr>
              <th>No</th>
              <th>Pengembang</th>
              <th>Fase</th>
              <th>Mapel</th>
              <th>Judul</th>
              <th>Download</th>
              <th>Aksi</th>
            </tr>
          </thead>
          <tbody>
      `;

      p.items.forEach((it, i) => {
        let dl = '-';
        if (it.download) {
          if (it.download.toLowerCase().startsWith('http')) {
            dl = `<a href="${esc(it.download)}" target="_blank">Download</a>`;
          } else {
            dl = esc(it.download);
          }
        }

        let aksiBtn = `
          <button class="btn btn-small btn-success"
            onclick="openKurasi(${it.row}, '${encodeURIComponent(k)}')">
            Kurasi
          </button>
        `;

        if (it.alreadyCuratedBy && it.alreadyCuratedBy.trim() !== '') {
          aksiBtn = `<button class="btn btn-small" disabled>Selesai</button>`;
        }

        h += `
          <tr>
            <td>${i+1}</td>
            <td>${esc(it.pengembang)}</td>
            <td>${esc(it.fase)}</td>
            <td>${esc(it.mapel)}</td>
            <td>${esc(it.judul)}</td>
            <td>${dl}</td>
            <td>${aksiBtn}</td>
          </tr>
        `;
      });

      h += '</tbody></table></div>';
      listArea.innerHTML = h;
    });
};

/* OPEN KURASI */
function openKurasi(row, kurEnc){
  const kur = decodeURIComponent(kurEnc);
  kurasiPanel.classList.remove('hidden');
  kurasiPanel.innerHTML = '<div class="loader"></div><div style="text-align:center">Menyiapkan Form...</div>';
  
  // Scroll ke form
  kurasiPanel.scrollIntoView({ behavior: 'smooth' });

  fetch(API_URL+`?action=payload&row=${row}&kurator=${encodeURIComponent(kur)}`)
    .then(r=>r.json())
    .then(p=>{
      let h = `<h3 class="kurasi-header">${esc(p.sumberJudul)}</h3>
               <p class="kurasi-subheader">Silakan lengkapi instrumen kurasi di bawah ini.</p>`;

      p.questions.forEach((q,i)=>{
        // Menggunakan wrapper question-block sesuai CSS baru
        h+=`
          <div class="question-block">
            <p>${i+1}. ${esc(q)}</p>
            <select id="q${i}">
              <option value="">-- Pilih Jawaban --</option>
              <option>Ya</option>
              <option>Tidak</option>
            </select>
            <textarea id="n${i}" rows="2" placeholder="Catatan perbaikan (jika ada)..."></textarea>
          </div>
        `;
      });

      h += `
        <div class="question-block" style="background:#fff7ed; border-color:#fdba74;">
          <p style="color:#9a3412;"><b>Komentar Umum / Kesimpulan Akhir</b></p>
          <textarea id="komentar" rows="4" placeholder="Tuliskan kesimpulan akhir di sini..."></textarea>
        </div>
      `;

      h+=`
        <div style="text-align:center; margin-top:20px;">
          <button class="btn btn-success"
            onclick="submitKurasi(${row},'${esc(kur)}',${p.questions.length})">
            Kirim Hasil Kurasi
          </button>
          <button class="btn btn-secondary" onclick="kurasiPanel.classList.add('hidden')">Batal</button>
        </div>
      `;

      kurasiPanel.innerHTML = h;
    });
}

/* SUBMIT */
function submitKurasi(row, kur, qc){
  const a=[], n=[];
  let firstEmpty = -1;

  for(let i=0; i<qc; i++){
    const val = document.getElementById('q'+i).value;
    a.push(val);
    n.push(document.getElementById('n'+i).value);

    if(!val && firstEmpty === -1){
      firstEmpty = i;
    }
  }

  if(firstEmpty !== -1){
    alert('Mohon lengkapi jawaban nomor ' + (firstEmpty+1));
    document.getElementById('q'+firstEmpty).focus();
    return;
  }

  // Tampilkan loading saat kirim
  const btnKirim = document.querySelector('#kurasiPanel .btn-success');
  const orgText = btnKirim.innerText;
  btnKirim.innerText = "Mengirim...";
  btnKirim.disabled = true;

  fetch(API_URL,{
    method:'POST',
    headers:{'Content-Type':'text/plain;charset=utf-8'},
    body:JSON.stringify({
      action:'submitKurasi',
      payload:{
        row,
        kurator: kur,
        answers: a,
        notes: n,
        komentar: document.getElementById('komentar').value || ''
      }
    })
  }).then(()=>{
    alert('Hasil kurasi berhasil disimpan!');
    kurasiPanel.classList.add('hidden');
    btnLoad.click(); // Refresh list
  }).catch(e => {
    alert('Gagal menyimpan. Coba lagi.');
    btnKirim.innerText = orgText;
    btnKirim.disabled = false;
  });
}

btnHasil.onclick = () => location.href='hasilkurasi.html';
</script>
</body>
</html>
