<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Hasil Kurasi</title>
<link rel="stylesheet" href="styles.css">
</head>

<body>

<div class="container">
  <header>
    <div class="logo-group">
      <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/9/9c/Logo_of_Ministry_of_Education_and_Culture_of_Republic_of_Indonesia.svg/1200px-Logo_of_Ministry_of_Education_and_Culture_of_Republic_of_Indonesia.svg.png">
      <img src="https://trigger.id/wp-content/uploads/2025/05/pendidikan-1024x452.png">
      <img src="https://kemendikdasmen.go.id/kem_base/static/src/img/ramah.png">
      <img src="https://cdn-sdotid.adg.id/images/70b5e75c-f103-4e51-9b76-432a91d07494_980x382.png">
    </div>

    <h1>Hasil Kurasi</h1>
    <h2 class="sub-header-line">Direktorat Sekolah Dasar</h2>
    <h2 class="sub-header-line">Direktorat Jenderal Pendidikan Anak Usia Dini, Pendidikan Dasar, dan Pendidikan Menengah</h2>
    <h2 class="sub-header-line">Kementerian Pendidikan Dasar dan Menengah</h2>
    <div class="muted">Lihat hasil penilaian dari para kurator.</div>

    <div class="controls">
      <select id="creator">
        <option value="">-- Memuat Daftar Pengembang --</option>
      </select>
      <button class="btn btn-primary" onclick="loadContents()">Tampilkan</button>
      <button class="btn btn-secondary" onclick="location.href='index.html'">Kembali ke Form</button>
    </div>
  </header>

  <div id="contentList" class="card">
    <div class="muted" style="text-align:center">Pilih nama pengembang di atas untuk melihat hasil.</div>
  </div>

  <div id="detail" class="card hidden"></div>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbxUlZ3SfTJY-WIDgMrjQAzVfl8aUPNBak3zvOfcLGLuOSNauo4Mjq85qWH6j3Ab6d916A/exec";

/* UTIL */
function esc(s){
  return String(s||'').replace(/[&<>"']/g,m=>(
    {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]
  ));
}

/* LOAD CREATOR */
function loadCreators(){
  fetch(API_URL+'?action=creators')
    .then(r=>r.json())
    .then(list=>{
      const sel = document.getElementById('creator');
      sel.innerHTML = '<option value="">-- Pilih Pengembang --</option>';
      list.forEach(n=>{
        sel.innerHTML += `<option>${esc(n)}</option>`;
      });
    });
}

/* LOAD CONTENTS + STATUS */
function loadContents(){
  const creator = document.getElementById('creator').value;
  if(!creator) return alert('Pilih pengembang terlebih dahulu');

  const list = document.getElementById('contentList');
  const detail = document.getElementById('detail');
  detail.classList.add('hidden');
  detail.innerHTML = '';
  list.innerHTML = '<div class="muted" style="text-align:center">Memuat data...</div>';

  Promise.all([
    fetch(API_URL+'?action=allContents').then(r=>r.json()),
    fetch(API_URL+'?action=hasil&kurator='+encodeURIComponent(creator)).then(r=>r.json())
  ])
  .then(([allData, hasilData])=>{

    const hasilMap = {};
    (hasilData.rows||[]).forEach(r=>{
      hasilMap[r[6]] = r; // key by Judul
    });

    let html = '';

    allData.forEach(it=>{
      if(it.pengembang !== creator) return;

      const sudah = it.status === true;
      const rowHasil = hasilMap[it.judul]; // dari HasilKurasi
      const namaKurator = rowHasil ? rowHasil[1] : '-';

      html += `
        <div class="content-item ${sudah?'done':'pending'}"
          ${sudah?`onclick="showDetail('${esc(it.judul)}')"`:''}>
          
          <div style="font-weight:700;font-size:16px;">
            ${esc(it.judul)}
          </div>

          <div style="font-size:13px;margin-top:4px;">
            Fase ${esc(it.fase)} • ${esc(it.mapel)}
          </div>

          <!-- ✅ BARIS INI DIKEMBALIKAN -->
          <small style="display:block;margin-top:6px;color:#64748b;">
            Kurator: <b>${esc(it.kurator || '-')}</b>
          </small>

          <small style="display:block;margin-top:2px;">
            Status:
            <b>${sudah?'Sudah Dikurasi':'Belum Dikurasi'}</b>
          </small>
        </div>
      `;

    });

    list.innerHTML = html || '<div class="muted" style="text-align:center">Tidak ada konten.</div>';
    window.__HASIL_CACHE__ = hasilData;
  })
  .catch(err=>{
    console.error(err);
    list.innerHTML = '<div class="muted">Gagal memuat data.</div>';
  });
}

/* SHOW DETAIL */
function showDetail(judul){
  const data = window.__HASIL_CACHE__;
  if(!data) return;

  const idx = data.rows.findIndex(r=>r[6]===judul);
  if(idx<0) return;

  const headers = data.headers;
  const row = data.rows[idx];
  const d = document.getElementById('detail');

  let html = `
    <h3>Detail Kurasi</h3>
    <table style="margin-bottom:15px">
      <tr><td><b>Judul</b></td><td>: ${esc(row[6])}</td></tr>
      <tr><td><b>Pengembang</b></td><td>: ${esc(row[3])}</td></tr>
      <tr><td><b>Fase / Mapel</b></td><td>: ${esc(row[4])} / ${esc(row[5])}</td></tr>
      <tr><td><b>Kurator</b></td><td>: ${esc(row[1])}</td></tr>
    </table>

    <div style="background:#f8fafc;padding:15px;border-radius:8px;border:1px solid #e2e8f0">
  `;

  for(let i=7;i<headers.length-1;i+=2){
    const q = headers[i];
    const j = row[i];
    const n = row[i+1];

    const badge =
      j==='Ya' ? 'background:#dcfce7;color:#166534;' :
      j==='Tidak' ? 'background:#fee2e2;color:#991b1b;' :
      'background:#f3f4f6;color:#555;';

    html += `
      <div style="margin-bottom:12px">
        <div style="font-weight:600">${esc(q)}</div>
        <div style="display:flex;gap:10px;margin-top:4px">
          <span style="${badge}padding:4px 10px;border-radius:6px;font-weight:bold">
            ${esc(j)||'-'}
          </span>
          <span style="font-style:italic;color:#475569">
            ${n?esc(n):''}
          </span>
        </div>
      </div>
    `;
  }

  html += `
    </div>
    <div style="margin-top:15px;background:#fff7ed;padding:15px;border-radius:8px;border:1px solid #fdba74">
      <b>Kesimpulan / Komentar Akhir</b>
      <p>${esc(row[headers.length-1])||'-'}</p>
    </div>

    <button class="btn btn-secondary" style="margin-top:15px;width:100%"
      onclick="d.classList.add('hidden');window.scrollTo(0,0)">
      Tutup Detail
    </button>
  `;

  d.innerHTML = html;
  d.classList.remove('hidden');
  d.scrollIntoView({behavior:'smooth'});
}

/* INIT */
loadCreators();
</script>
</body>
</html>
